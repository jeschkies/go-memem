// Code generated by command: go run asm.go -out bytes.s -stubs bytes.go. DO NOT EDIT.

#include "textflag.h"

// func Search(haystack []byte, needle []byte) bool
// Requires: AVX, AVX2, BMI
TEXT Â·Search(SB), NOSPLIT, $0-49
	MOVQ needle_base+24(FP), AX
	MOVQ needle_len+32(FP), CX
	MOVQ haystack_base+0(FP), DX
	MOVQ haystack_len+8(FP), BX
	SUBQ CX, BX

	// create vector filled with first and last character
	VPBROADCASTB needle+0(FP), Y0
	MOVQ         needle+0(FP), SI
	ADDQ         CX, SI
	DECQ         SI
	VPBROADCASTB (SI), Y1

chunk_loop:
	CMPQ DX, BX
	JG   chunk_loop_end

	// compare blocks against first and last character
	VMOVDQU  (AX), Y2
	VMOVDQU  (AX), Y3
	VPCMPEQB Y0, Y2, Y2
	VPCMPEQB Y1, Y3, Y3

	// create mask and determine position
	VPAND     Y2, Y3, Y2
	VPMOVMSKB Y2, SI

mask_loop:
	CMPL   SI, $0x00
	JE     mask_loop_done
	TZCNTL SI, DI
	JMP    mask_loop

mask_loop_done:
	ADDQ $0x20, DX
	JMP  chunk_loop

chunk_loop_end:
	// compare two slices
	MOVQ haystack_base+0(FP), DX
	MOVQ haystack_len+8(FP), BX

memcmp_loop:
	CMPQ CX, $0x00
	JE   done
	CMPQ BX, $0x00
	JE   done
	MOVB (DX), SI
	CMPB (AX), SI
	JNE  not_equal
	ADDQ $0x01, AX
	DECQ CX
	ADDQ $0x01, DX
	DECQ BX
	JMP  memcmp_loop

done:
	// check if both are done
	CMPQ CX, BX
	JE   equal

not_equal:
	MOVB $0x00, ret+48(FP)
	RET

equal:
	MOVB $0x01, ret+48(FP)
	RET
